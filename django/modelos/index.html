<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Modelos - Curso Django Completo</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Curso Django Completo</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Inicio</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Django</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Modelos</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Paquetes</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../paquetes/extensiones/" class="dropdown-item">Extensiones Esenciales</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Primeros Pasos</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../primeros-pasos/configuracion-inicial/" class="dropdown-item">Configuración Inicial</a>
</li>
                                    
<li>
    <a href="../../primeros-pasos/usuarios-autenticacion-perfiles/" class="dropdown-item">Usuarios, Autenticación y Perfiles</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Produccion</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../produccion/preparar-produccion/" class="dropdown-item">Configuración para Producción</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../.." class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../paquetes/extensiones/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#guia-completa-de-modelspy-en-django" class="nav-link">Guía Completa de Models.py en Django</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#1-definicion-basica-de-modelos" class="nav-link">1. Definición básica de modelos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#2-todos-los-tipos-de-campos-disponibles" class="nav-link">2. Todos los tipos de campos disponibles</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#3-opciones-comunes-para-todos-los-campos" class="nav-link">3. Opciones comunes para todos los campos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#4-relaciones-entre-modelos" class="nav-link">4. Relaciones entre modelos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#5-metodos-y-propiedades-personalizados" class="nav-link">5. Métodos y propiedades personalizados</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#6-metodos-estaticos-y-de-clase" class="nav-link">6. Métodos estáticos y de clase</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#7-sobreescritura-de-metodos-del-modelo" class="nav-link">7. Sobreescritura de métodos del modelo</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#8-meta-opciones" class="nav-link">8. Meta opciones</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#9-managers-personalizados" class="nav-link">9. Managers personalizados</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#10-herencia-de-modelos" class="nav-link">10. Herencia de modelos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#11-senales-signals" class="nav-link">11. Señales (Signals)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#12-campos-personalizados" class="nav-link">12. Campos personalizados</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#13-operaciones-avanzadas-con-querysets" class="nav-link">13. Operaciones avanzadas con QuerySets</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#14-consultas-y-joins-complejos" class="nav-link">14. Consultas y joins complejos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#15-transacciones-y-operaciones-atomicas" class="nav-link">15. Transacciones y operaciones atómicas</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#16-indices-constraints-y-referencias-complejas" class="nav-link">16. Índices, Constraints y Referencias complejas</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#17-funciones-de-busqueda-y-expresiones-avanzadas" class="nav-link">17. Funciones de Búsqueda y Expresiones Avanzadas</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#18-opciones-de-definicion-de-modelos-menos-comunes" class="nav-link">18. Opciones de Definición de Modelos menos comunes</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#19-integracion-con-otros-sistemas-y-orm-avanzado" class="nav-link">19. Integración con otros sistemas y ORM avanzado</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="guia-completa-de-modelspy-en-django">Guía Completa de Models.py en Django</h1>
<p>Los modelos son el corazón de Django, actuando como la única fuente de verdad sobre tus datos. Esta guía exhaustiva cubre todo lo que puedes hacer con ellos, desde lo básico hasta técnicas avanzadas.</p>
<h2 id="1-definicion-basica-de-modelos">1. Definición básica de modelos</h2>
<pre><code class="language-python">from django.db import models

class Producto(models.Model):
    nombre = models.CharField(max_length=100)
    precio = models.DecimalField(max_digits=10, decimal_places=2)
    descripcion = models.TextField(blank=True)
    en_stock = models.BooleanField(default=True)
    fecha_creacion = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.nombre
</code></pre>
<h2 id="2-todos-los-tipos-de-campos-disponibles">2. Todos los tipos de campos disponibles</h2>
<h3 id="campos-de-texto">Campos de texto</h3>
<pre><code class="language-python"># Cadenas cortas
titulo = models.CharField(max_length=200)  # Requerido especificar max_length
codigo = models.SlugField(max_length=50)   # Letras, números, guiones, guiones bajos
nombre_usuario = models.SlugField(max_length=30, allow_unicode=True)  # Permite Unicode

# URLs y correos
sitio_web = models.URLField(max_length=200)  # Valida formato URL
email = models.EmailField(max_length=254)    # Valida formato email

# Texto largo
descripcion = models.TextField()  # Texto ilimitado
html_content = models.TextField(help_text=&quot;Contenido HTML de la página&quot;)
</code></pre>
<h3 id="campos-numericos">Campos numéricos</h3>
<pre><code class="language-python"># Enteros
edad = models.IntegerField()  # -2147483648 a 2147483647
cantidad = models.PositiveIntegerField()  # 0 a 2147483647
plazas = models.PositiveSmallIntegerField()  # 0 a 32767
poblacion = models.BigIntegerField()  # -9223372036854775808 a 9223372036854775807

# Decimales
precio = models.DecimalField(max_digits=10, decimal_places=2)  # Precisión exacta
altura = models.FloatField()  # Coma flotante (menos preciso pero más rápido)

# Booleanos
activo = models.BooleanField(default=True)
enviado = models.BooleanField()
</code></pre>
<h3 id="campos-de-fecha-y-hora">Campos de fecha y hora</h3>
<pre><code class="language-python">fecha_nacimiento = models.DateField()
hora_entrega = models.TimeField()
fecha_hora_creacion = models.DateTimeField()
fecha_modificacion = models.DateTimeField(auto_now=True)  # Se actualiza en cada save()
fecha_creacion = models.DateTimeField(auto_now_add=True)  # Solo se establece en create()
duracion = models.DurationField()  # Para almacenar períodos de tiempo
</code></pre>
<h3 id="campos-de-archivo">Campos de archivo</h3>
<pre><code class="language-python"># Archivos y imágenes
documento = models.FileField(upload_to='documentos/')
imagen = models.ImageField(upload_to='imagenes/%Y/%m/')  # Requiere Pillow
archivo_pdf = models.FileField(
    upload_to='pdfs/',
    validators=[FileExtensionValidator(allowed_extensions=['pdf'])]
)

# Campos especializados para almacenar ubicaciones de archivos
imagen_portada = models.FilePathField(path='/var/www/images/')
</code></pre>
<h3 id="otros-campos">Otros campos</h3>
<pre><code class="language-python"># Campos binarios
datos = models.BinaryField()  # Para almacenar datos binarios brutos

# JSON y otros formatos
configuracion = models.JSONField(default=dict)  # Requiere PostgreSQL o similar

# Campos especiales
uuid = models.UUIDField(default=uuid.uuid4, editable=False, unique=True)
ip = models.GenericIPAddressField(protocol='both', unpack_ipv4=True)
</code></pre>
<h2 id="3-opciones-comunes-para-todos-los-campos">3. Opciones comunes para todos los campos</h2>
<pre><code class="language-python">class Producto(models.Model):
    nombre = models.CharField(
        max_length=100,                 # Longitud máxima (obligatorio para CharField)
        verbose_name=&quot;Nombre producto&quot;, # Nombre legible para humanos
        help_text=&quot;Ingrese el nombre del producto&quot;, # Texto de ayuda
        null=True,                      # Permite valores NULL en la BD
        blank=True,                     # Permite valores vacíos en formularios
        default=&quot;Producto nuevo&quot;,       # Valor por defecto
        editable=False,                 # No se muestra en formularios
        unique=True,                    # Valor único en la tabla
        db_index=True,                  # Crea índice en la BD para este campo
        primary_key=False,              # No es clave primaria
        db_column=&quot;product_name&quot;,       # Nombre de columna específico en la BD
        choices=(                       # Lista predefinida de opciones
            ('S', 'Small'),
            ('M', 'Medium'),
            ('L', 'Large'),
        ),
        validators=[MinLengthValidator(3)], # Lista de validadores
        error_messages={                    # Mensajes de error personalizados
            'null': 'Este campo no puede ser nulo',
            'blank': 'Este campo es obligatorio',
        }
    )
</code></pre>
<h2 id="4-relaciones-entre-modelos">4. Relaciones entre modelos</h2>
<h3 id="foreignkey-relacion-uno-a-muchos">ForeignKey (Relación uno a muchos)</h3>
<pre><code class="language-python">class Categoria(models.Model):
    nombre = models.CharField(max_length=100)

    def __str__(self):
        return self.nombre

class Producto(models.Model):
    # Muchos productos pueden pertenecer a una categoría
    categoria = models.ForeignKey(
        Categoria,                      # Modelo relacionado
        on_delete=models.CASCADE,       # Comportamiento al eliminar: CASCADE, PROTECT, SET_NULL, SET_DEFAULT, DO_NOTHING, SET()
        related_name='productos',       # Nombre para la relación inversa
        related_query_name='producto',  # Nombre para filtros en consultas inversas
        limit_choices_to={'activa': True}, # Limita las opciones disponibles
        db_constraint=True,             # Crea restricción en la BD
        to_field='id',                  # Campo al que se relaciona (por defecto es pk)
        swappable=True,                 # Si se puede intercambiar el modelo relacionado
        db_index=True,                  # Crea índice para este campo
        null=True,                      # Permite nulos
        blank=True                      # Permite vacíos en formularios
    )

    # Auto-referencia (un producto puede ser el repuesto de otro)
    repuesto_de = models.ForeignKey('self', on_delete=models.SET_NULL, null=True, blank=True)

    # Referencias a modelos aún no definidos
    creado_por = models.ForeignKey('auth.User', on_delete=models.PROTECT)
</code></pre>
<h3 id="manytomanyfield-relacion-muchos-a-muchos">ManyToManyField (Relación muchos a muchos)</h3>
<pre><code class="language-python">class Etiqueta(models.Model):
    nombre = models.CharField(max_length=50)

    def __str__(self):
        return self.nombre

class Producto(models.Model):
    # Un producto puede tener muchas etiquetas y una etiqueta puede estar en muchos productos
    etiquetas = models.ManyToManyField(
        Etiqueta,
        related_name='productos',
        blank=True,
        through='ProductoEtiqueta',     # Modelo para la tabla intermedia personalizada
        through_fields=('producto', 'etiqueta'),  # Campos para la relación en el modelo through
        db_table='producto_etiqueta',   # Nombre de la tabla intermedia en la BD
        symmetrical=False,              # Para relaciones ManyToMany con 'self'
    )

    # Auto-referencia (productos compatibles con este producto)
    compatible_con = models.ManyToManyField('self', blank=True, symmetrical=False)

# Tabla intermedia personalizada para añadir campos a la relación
class ProductoEtiqueta(models.Model):
    producto = models.ForeignKey(Producto, on_delete=models.CASCADE)
    etiqueta = models.ForeignKey(Etiqueta, on_delete=models.CASCADE)
    fecha_asignacion = models.DateTimeField(auto_now_add=True)
    asignado_por = models.ForeignKey('auth.User', on_delete=models.SET_NULL, null=True)

    class Meta:
        # Garantiza que no haya duplicados
        unique_together = [['producto', 'etiqueta']]
</code></pre>
<h3 id="onetoonefield-relacion-uno-a-uno">OneToOneField (Relación uno a uno)</h3>
<pre><code class="language-python">class Empleado(models.Model):
    nombre = models.CharField(max_length=100)
    apellido = models.CharField(max_length=100)

class Perfil(models.Model):
    # Un perfil pertenece a un solo empleado y un empleado tiene un solo perfil
    empleado = models.OneToOneField(
        Empleado,
        on_delete=models.CASCADE,
        primary_key=True,          # Usa el mismo ID que el empleado
        parent_link=True,          # Para herencia multi-tabla
    )
    fecha_nacimiento = models.DateField(null=True, blank=True)
    foto = models.ImageField(upload_to='perfiles/', null=True, blank=True)
</code></pre>
<h2 id="5-metodos-y-propiedades-personalizados">5. Métodos y propiedades personalizados</h2>
<pre><code class="language-python">from django.utils import timezone
import datetime

class Producto(models.Model):
    nombre = models.CharField(max_length=100)
    precio = models.DecimalField(max_digits=10, decimal_places=2)
    costo = models.DecimalField(max_digits=10, decimal_places=2)
    stock = models.PositiveIntegerField(default=0)
    fecha_caducidad = models.DateField(null=True, blank=True)

    # Propiedad calculada
    @property
    def margen(self):
        &quot;&quot;&quot;Calcula el margen de beneficio&quot;&quot;&quot;
        if self.costo == 0:
            return 0
        return ((self.precio - self.costo) / self.precio) * 100

    # Propiedad con setter
    @property
    def precio_con_iva(self):
        &quot;&quot;&quot;Precio con IVA incluido&quot;&quot;&quot;
        return self.precio * 1.21

    @precio_con_iva.setter
    def precio_con_iva(self, valor):
        &quot;&quot;&quot;Establece el precio sin IVA a partir del precio con IVA&quot;&quot;&quot;
        self.precio = valor / 1.21

    # Método de instancia
    def esta_disponible(self):
        &quot;&quot;&quot;Determina si el producto está disponible&quot;&quot;&quot;
        if self.stock &lt;= 0:
            return False
        if self.fecha_caducidad and self.fecha_caducidad &lt;= timezone.now().date():
            return False
        return True

    # Método con parámetros
    def aplicar_descuento(self, porcentaje):
        &quot;&quot;&quot;Aplica un descuento al precio del producto&quot;&quot;&quot;
        if porcentaje &lt; 0 or porcentaje &gt; 100:
            raise ValueError(&quot;El porcentaje debe estar entre 0 y 100&quot;)
        self.precio = self.precio * (1 - (porcentaje / 100))
        return self.precio

    # Método que modifica múltiples campos
    def recibir_stock(self, cantidad, nuevo_costo=None):
        &quot;&quot;&quot;Añade stock y actualiza el costo si se proporciona&quot;&quot;&quot;
        if cantidad &lt;= 0:
            raise ValueError(&quot;La cantidad debe ser positiva&quot;)

        self.stock += cantidad

        if nuevo_costo is not None:
            self.costo = nuevo_costo

        self.save(update_fields=['stock', 'costo'])
        return self.stock

    # Método que interactúa con otras instancias
    def transferir_stock(self, producto_destino, cantidad):
        &quot;&quot;&quot;Transfiere stock a otro producto&quot;&quot;&quot;
        if cantidad &lt;= 0:
            raise ValueError(&quot;La cantidad debe ser positiva&quot;)
        if cantidad &gt; self.stock:
            raise ValueError(&quot;Stock insuficiente&quot;)

        self.stock -= cantidad
        producto_destino.stock += cantidad

        self.save(update_fields=['stock'])
        producto_destino.save(update_fields=['stock'])

    # Método que devuelve un valor complejo o QuerySet
    def obtener_productos_similares(self):
        &quot;&quot;&quot;Encuentra productos con precios similares&quot;&quot;&quot;
        min_precio = self.precio * 0.9
        max_precio = self.precio * 1.1

        return Producto.objects.filter(
            precio__gte=min_precio,
            precio__lte=max_precio
        ).exclude(id=self.id)
</code></pre>
<h2 id="6-metodos-estaticos-y-de-clase">6. Métodos estáticos y de clase</h2>
<pre><code class="language-python">class Producto(models.Model):
    nombre = models.CharField(max_length=100)
    precio = models.DecimalField(max_digits=10, decimal_places=2)

    # Método estático (no accede a la instancia ni a la clase)
    @staticmethod
    def convertir_moneda(precio, tasa_cambio):
        &quot;&quot;&quot;Convierte un precio a otra moneda usando la tasa de cambio&quot;&quot;&quot;
        return precio * tasa_cambio

    # Método de clase (accede a la clase pero no a la instancia)
    @classmethod
    def crear_oferta(cls, nombre, precio_original, descuento_porcentaje):
        &quot;&quot;&quot;Crea un nuevo producto con descuento aplicado&quot;&quot;&quot;
        precio_con_descuento = precio_original * (1 - (descuento_porcentaje / 100))
        return cls.objects.create(
            nombre=f&quot;{nombre} (Oferta {descuento_porcentaje}%)&quot;,
            precio=precio_con_descuento
        )

    # Método de clase que devuelve un QuerySet
    @classmethod
    def obtener_productos_caros(cls):
        &quot;&quot;&quot;Obtiene productos con precio superior a la media&quot;&quot;&quot;
        from django.db.models import Avg
        precio_medio = cls.objects.aggregate(Avg('precio'))['precio__avg']
        return cls.objects.filter(precio__gt=precio_medio)
</code></pre>
<h2 id="7-sobreescritura-de-metodos-del-modelo">7. Sobreescritura de métodos del modelo</h2>
<pre><code class="language-python">class Producto(models.Model):
    nombre = models.CharField(max_length=100)
    slug = models.SlugField(unique=True)

    # Personalizar representación en string
    def __str__(self):
        return f&quot;{self.nombre} ({self.id})&quot;

    # Personalizar representación en depuración
    def __repr__(self):
        return f&quot;&lt;Producto: {self.id}, {self.nombre}&gt;&quot;

    # Personalizar el comportamiento de guardado
    def save(self, *args, **kwargs):
        # Acciones antes de guardar
        if not self.slug:
            from django.utils.text import slugify
            self.slug = slugify(self.nombre)

        # Validaciones personalizadas
        if len(self.nombre) &lt; 3:
            raise ValueError(&quot;El nombre debe tener al menos 3 caracteres&quot;)

        # Llamar al método original
        super().save(*args, **kwargs)

        # Acciones después de guardar
        self.crear_thumbnail()

    # Personalizar el comportamiento de eliminación
    def delete(self, *args, **kwargs):
        # Acciones antes de eliminar
        self.eliminar_archivos_asociados()

        # Llamar al método original
        super().delete(*args, **kwargs)

        # Acciones después de eliminar (cuidado: la instancia ya no existe en la BD)

    # Personalizar el comportamiento de validación
    def clean(self):
        &quot;&quot;&quot;Validaciones a nivel de modelo (no de campo)&quot;&quot;&quot;
        from django.core.exceptions import ValidationError

        if self.precio &lt; self.costo:
            raise ValidationError(&quot;El precio no puede ser menor que el costo&quot;)

        if self.fecha_inicio and self.fecha_fin and self.fecha_inicio &gt; self.fecha_fin:
            raise ValidationError({
                'fecha_inicio': &quot;La fecha de inicio no puede ser posterior a la fecha de fin&quot;,
                'fecha_fin': &quot;La fecha de fin no puede ser anterior a la fecha de inicio&quot;
            })

    # Personalizar URLs
    def get_absolute_url(self):
        &quot;&quot;&quot;Devuelve la URL única para este objeto&quot;&quot;&quot;
        from django.urls import reverse
        return reverse('producto-detalle', kwargs={'slug': self.slug})
</code></pre>
<h2 id="8-meta-opciones">8. Meta opciones</h2>
<pre><code class="language-python">class Producto(models.Model):
    nombre = models.CharField(max_length=100)
    precio = models.DecimalField(max_digits=10, decimal_places=2)

    class Meta:
        # Nombre y plurales para la interfaz de administración
        verbose_name = &quot;Producto&quot;
        verbose_name_plural = &quot;Productos&quot;

        # Ordenación por defecto
        ordering = ['-fecha_creacion', 'nombre']

        # Índices para optimizar consultas
        indexes = [
            models.Index(fields=['nombre']),
            models.Index(fields=['precio', 'categoria']),
            models.Index(fields=['-fecha_creacion'], name='idx_fecha_creacion_desc'),
        ]

        # Restricciones de unicidad compuesta
        unique_together = [['sku', 'tienda'], ['slug', 'categoria']]

        # Restricciones de unicidad con condiciones (Django 2.2+)
        constraints = [
            models.UniqueConstraint(
                fields=['sku', 'tienda'], 
                name='unique_sku_por_tienda'
            ),
            models.UniqueConstraint(
                fields=['slug'],
                condition=models.Q(activo=True),
                name='unique_slug_activos'
            ),
            models.CheckConstraint(
                check=models.Q(precio__gte=0),
                name='precio_positivo'
            ),
        ]

        # Nombrar la tabla en la base de datos
        db_table = 'inventario_producto'

        # Otras opciones Meta
        abstract = False              # Si es True, será un modelo abstracto
        app_label = 'inventario'      # Especifica la app a la que pertenece
        db_tablespace = 'idx_tbls'    # Espacio de tabla para índices
        default_permissions = ('add', 'change', 'delete', 'view')
        default_related_name = 'productos'  # Nombre relacional por defecto
        get_latest_by = 'fecha_creacion'    # Campo para latest() y earliest()
        managed = True                # Si Django gestiona esta tabla
        order_with_respect_to = 'categoria'  # Permite ordenar respecto a otro campo
        permissions = [               # Permisos adicionales
            ('puede_publicar', 'Puede publicar productos'),
            ('puede_destacar', 'Puede destacar productos'),
        ]
        proxy = False                 # Si es modelo proxy
        required_db_features = ['supports_json_field']  # Características requeridas de la BD
        select_on_save = False        # Si hacer SELECT antes de guardar
</code></pre>
<h2 id="9-managers-personalizados">9. Managers personalizados</h2>
<pre><code class="language-python">class ProductoActivoManager(models.Manager):
    &quot;&quot;&quot;Manager que solo devuelve productos activos&quot;&quot;&quot;
    def get_queryset(self):
        return super().get_queryset().filter(activo=True)

    # Método personalizado del manager
    def destacados(self):
        &quot;&quot;&quot;Devuelve productos activos y destacados&quot;&quot;&quot;
        return self.filter(destacado=True)

    # Método para crear objetos con valores por defecto
    def crear_producto_destacado(self, nombre, precio, **kwargs):
        return self.create(
            nombre=nombre,
            precio=precio,
            destacado=True,
            **kwargs
        )

class ProductoDesactivoManager(models.Manager):
    &quot;&quot;&quot;Manager que solo devuelve productos inactivos&quot;&quot;&quot;
    def get_queryset(self):
        return super().get_queryset().filter(activo=False)

class ProductoQuerySet(models.QuerySet):
    &quot;&quot;&quot;QuerySet personalizado con métodos adicionales&quot;&quot;&quot;

    def destacados(self):
        return self.filter(destacado=True)

    def por_precio(self, precio_min, precio_max):
        return self.filter(precio__gte=precio_min, precio__lte=precio_max)

    def agotados(self):
        return self.filter(stock=0)

    # Métodos que modifiquen datos en masa
    def destacar_todos(self):
        return self.update(destacado=True)

    def subir_precio(self, porcentaje):
        from django.db.models import F
        return self.update(precio=F('precio') * (1 + porcentaje/100))

class Producto(models.Model):
    nombre = models.CharField(max_length=100)
    precio = models.DecimalField(max_digits=10, decimal_places=2)
    stock = models.PositiveIntegerField(default=0)
    activo = models.BooleanField(default=True)
    destacado = models.BooleanField(default=False)

    # Manager por defecto
    objects = models.Manager()

    # Managers adicionales
    activos = ProductoActivoManager()
    inactivos = ProductoDesactivoManager()

    # Manager personalizado que devuelve QuerySet personalizado
    todo = models.Manager.from_queryset(ProductoQuerySet)()

    def __str__(self):
        return self.nombre
</code></pre>
<p>Ahora podemos usar:</p>
<pre><code class="language-python"># Usando los diferentes managers
Producto.objects.all()           # Todos los productos
Producto.activos.all()           # Solo productos activos
Producto.inactivos.all()         # Solo productos inactivos
Producto.activos.destacados()    # Productos activos y destacados

# Usando el QuerySet personalizado
Producto.todo.destacados()
Producto.todo.por_precio(10, 100)
Producto.todo.agotados()

# Operaciones en masa
Producto.todo.filter(categoria=5).destacar_todos()
Producto.todo.filter(marca=&quot;Sony&quot;).subir_precio(5)
</code></pre>
<h2 id="10-herencia-de-modelos">10. Herencia de modelos</h2>
<h3 id="herencia-abstracta">Herencia abstracta</h3>
<pre><code class="language-python">class ModeloBase(models.Model):
    &quot;&quot;&quot;Modelo abstracto con campos comunes&quot;&quot;&quot;
    creado = models.DateTimeField(auto_now_add=True)
    modificado = models.DateTimeField(auto_now=True)
    activo = models.BooleanField(default=True)

    class Meta:
        abstract = True  # No crea tabla para este modelo

    def activar(self):
        self.activo = True
        self.save(update_fields=['activo'])

    def desactivar(self):
        self.activo = False
        self.save(update_fields=['activo'])

class Producto(ModeloBase):
    &quot;&quot;&quot;Hereda todos los campos y métodos de ModeloBase&quot;&quot;&quot;
    nombre = models.CharField(max_length=100)
    precio = models.DecimalField(max_digits=10, decimal_places=2)

    # Puede añadir sus propias Meta opciones
    class Meta(ModeloBase.Meta):
        verbose_name = &quot;Producto&quot;
        ordering = ['-creado']

class Cliente(ModeloBase):
    &quot;&quot;&quot;También hereda de ModeloBase&quot;&quot;&quot;
    nombre = models.CharField(max_length=100)
    email = models.EmailField()
</code></pre>
<h3 id="herencia-multi-tabla">Herencia multi-tabla</h3>
<pre><code class="language-python">class Producto(models.Model):
    &quot;&quot;&quot;Modelo base para todos los productos&quot;&quot;&quot;
    nombre = models.CharField(max_length=100)
    descripcion = models.TextField(blank=True)
    precio = models.DecimalField(max_digits=10, decimal_places=2)

    def __str__(self):
        return self.nombre

class Libro(Producto):
    &quot;&quot;&quot;Crea una tabla separada con un OneToOneField a Producto&quot;&quot;&quot;
    autor = models.CharField(max_length=100)
    isbn = models.CharField(max_length=13)
    paginas = models.PositiveIntegerField()

    def __str__(self):
        return f&quot;{self.nombre} de {self.autor}&quot;

class Electronico(Producto):
    &quot;&quot;&quot;Otra tabla separada con relación a Producto&quot;&quot;&quot;
    marca = models.CharField(max_length=50)
    modelo = models.CharField(max_length=50)
    garantia_meses = models.PositiveIntegerField()

    def __str__(self):
        return f&quot;{self.marca} {self.modelo}&quot;
</code></pre>
<h3 id="herencia-proxy">Herencia proxy</h3>
<pre><code class="language-python">class Producto(models.Model):
    nombre = models.CharField(max_length=100)
    precio = models.DecimalField(max_digits=10, decimal_places=2)
    tipo = models.CharField(max_length=20, choices=[
        ('normal', 'Normal'),
        ('destacado', 'Destacado'),
        ('oferta', 'Oferta')
    ])

    def __str__(self):
        return self.nombre

class ProductoDestacado(Producto):
    &quot;&quot;&quot;
    Modelo proxy que no crea nueva tabla, sino que
    proporciona una vista diferente del modelo Producto
    &quot;&quot;&quot;
    objects = models.Manager()  # Manager por defecto

    class Meta:
        proxy = True  # Es un modelo proxy
        ordering = ['-precio']  # Ordenación diferente

    def destacar(self):
        self.tipo = 'destacado'
        self.save()

    @property
    def precio_original(self):
        &quot;&quot;&quot;Calcula el precio original antes del descuento&quot;&quot;&quot;
        return self.precio * 1.2
</code></pre>
<h2 id="11-senales-signals">11. Señales (Signals)</h2>
<pre><code class="language-python"># En models.py o en signals.py
from django.db.models.signals import pre_save, post_save, pre_delete, post_delete
from django.dispatch import receiver
from .models import Producto

@receiver(pre_save, sender=Producto)
def producto_pre_save(sender, instance, **kwargs):
    &quot;&quot;&quot;Se ejecuta antes de guardar un producto&quot;&quot;&quot;
    # Podemos modificar la instancia antes de guardarla
    if instance.stock &lt; 0:
        instance.stock = 0

    # Calcular campos derivados
    if instance.precio and instance.costo:
        instance.margen = instance.precio - instance.costo

@receiver(post_save, sender=Producto)
def producto_post_save(sender, instance, created, **kwargs):
    &quot;&quot;&quot;Se ejecuta después de guardar un producto&quot;&quot;&quot;
    if created:
        # Solo si es un producto nuevo
        from .tasks import notificar_nuevo_producto
        notificar_nuevo_producto.delay(instance.id)
    else:
        # Si es una actualización
        if 'precio' in kwargs.get('update_fields', []):
            from .tasks import actualizar_precios_relacionados
            actualizar_precios_relacionados.delay(instance.id)

@receiver(pre_delete, sender=Producto)
def producto_pre_delete(sender, instance, **kwargs):
    &quot;&quot;&quot;Se ejecuta antes de eliminar un producto&quot;&quot;&quot;
    # Guardar registro de eliminación
    from .models import RegistroEliminacion
    RegistroEliminacion.objects.create(
        modelo='Producto',
        objeto_id=instance.id,
        nombre=instance.nombre,
        datos=str(instance.__dict__)
    )

    # Eliminar archivos asociados
    if instance.imagen:
        import os
        if os.path.isfile(instance.imagen.path):
            os.remove(instance.imagen.path)

@receiver(post_delete, sender=Producto)
def producto_post_delete(sender, instance, **kwargs):
    &quot;&quot;&quot;Se ejecuta después de eliminar un producto&quot;&quot;&quot;
    # Actualizar caché o búsqueda
    from .tasks import actualizar_cache_productos
    actualizar_cache_productos.delay()

# Señales personalizadas
from django.dispatch import Signal

# Definir una señal personalizada
producto_agotado = Signal()  # Puede incluir providing_args=['producto']

class Venta(models.Model):
    producto = models.ForeignKey(Producto, on_delete=models.CASCADE)
    cantidad = models.PositiveIntegerField()

    def save(self, *args, **kwargs):
        super().save(*args, **kwargs)

        # Actualizar stock
        self.producto.stock -= self.cantidad
        self.producto.save(update_fields=['stock'])

        # Emitir señal si el producto se agotó
        if self.producto.stock == 0:
            producto_agotado.send(sender=self.__class__, producto=self.producto)

# En otro lugar, escuchar la señal personalizada
@receiver(producto_agotado)
def notificar_producto_agotado(sender, producto, **kwargs):
    from django.core.mail import send_mail
    send_mail(
        f'Producto agotado: {producto.nombre}',
        f'El producto {producto.nombre} se ha agotado.',
        'sistema@ejemplo.com',
        ['almacen@ejemplo.com'],
    )
</code></pre>
<h2 id="12-campos-personalizados">12. Campos personalizados</h2>
<pre><code class="language-python">from django.db import models
from django.core.exceptions import ValidationError

def validar_rango(value):
    if value &lt; 0 or value &gt; 100:
        raise ValidationError('El valor debe estar entre 0 y 100')

class RangoEnteroField(models.IntegerField):
    &quot;&quot;&quot;Campo entero con validación de rango personalizada&quot;&quot;&quot;

    def __init__(self, min_value=None, max_value=None, *args, **kwargs):
        self.min_value = min_value
        self.max_value = max_value
        super().__init__(*args, **kwargs)

    def formfield(self, **kwargs):
        # Personaliza el campo de formulario
        defaults = {
            'min_value': self.min_value,
            'max_value': self.max_value,
        }
        defaults.update(kwargs)
        return super().formfield(**defaults)

    def deconstruct(self):
        # Necesario para las migraciones
        name, path, args, kwargs = super().deconstruct()
        if self.min_value is not None:
            kwargs['min_value'] = self.min_value
        if self.max_value is not None:
            kwargs['max_value'] = self.max_value
        return name, path, args, kwargs

    def validate(self, value, model_instance):
        # Validación personalizada
        super().validate(value, model_instance)
        if self.min_value is not None and value &lt; self.min_value:
            raise ValidationError(f'El valor debe ser mayor o igual a {self.min_value}')
        if self.max_value is not None and value &gt; self.max_value:
            raise ValidationError(f'El valor debe ser menor o igual a {self.max_value}')

class ColorField(models.CharField):
    &quot;&quot;&quot;Campo para almacenar colores en formato hexadecimal&quot;&quot;&quot;

    def __init__(self, *args, **kwargs):
        kwargs['max_length'] = 7
        super().__init__(*args, **kwargs)

    def clean(self, value, model_instance):
        value = super().clean(value, model_instance)
        if value and not value.startswith('#'):
            value = f'#{value}'
        return value

    def validate(self, value, model_instance):
        super().validate(value, model_instance)
        if value:
            import re
            if not re.match(r'^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$', value):
                raise ValidationError('Formato de color hexadecimal inválido')

class Producto(models.Model):
    nombre = models.CharField(max_length=100)
    calificacion = RangoEnteroField(min_value=1, max_value=5, help_text=&quot;Calificación de 1 a 5 estrellas&quot;)
    color_principal = ColorField(null=True, blank=True, help_text=&quot;Color en formato hexadecimal (#RRGGBB)&quot;)
</code></pre>
<h2 id="13-operaciones-avanzadas-con-querysets">13. Operaciones avanzadas con QuerySets</h2>
<pre><code class="language-python">from django.db.models import F, Q, Count, Sum, Avg, Min, Max, Case, When, Value, IntegerField, CharField
from django.db.models.functions import ExtractYear, ExtractMonth, Concat

class Producto(models.Model):
    nombre = models.CharField(max_length=100)
    precio = models.DecimalField(max_digits=10, decimal_places=2)
    stock = models.PositiveIntegerField(default=0)
    categoria = models.ForeignKey('Categoria', on_delete=models.CASCADE)
    fecha_creacion = models.DateTimeField(auto_now_add=True)

    @classmethod
    def consultas_avanzadas(cls):
        # Ejemplos de consultas avanzadas

        # F expressions - Operaciones a nivel de base de datos
        cls.objects.update(precio=F('precio') * 1.1)  # Aumenta todos los precios un 10%

        # Productos cuyo precio es mayor que el precio base
        productos_caros = cls.objects.filter(precio__gt=F('precio_base'))

        # Productos con más ventas que stock
        productos_exitosos = cls.objects.filter(ventas_totales__gt=F('stock'))

        # Q expressions - Consultas complejas con OR, AND, NOT
        from django.db.models import Q

        # Productos baratos O con stock alto
        productos = cls.objects.filter(
            Q(precio__lt=10) | Q(stock__gt=100)
        )

        # Productos caros Y de categoría específica, excluyendo una marca
        productos = cls.objects.filter(
            Q(precio__gt=50) &amp; 
            Q(categoria__nombre='Electrónica') &amp;
            ~Q(marca='Marca Genérica')
        )

        # Funciones de agregación
        from django.db.models import Avg, Count, Min, Max, Sum

        # Estadísticas generales
        stats = cls.objects.aggregate(
            total_productos=Count('id'),
            precio_promedio=Avg('precio'),
            precio_minimo=Min('precio'),
            precio_maximo=Max('precio'),
            valor_inventario=Sum(F('precio') * F('stock'))
        )

        # Anotaciones - Añadir campos calculados a cada objeto
        productos = cls.objects.annotate(
            valor_total=F('precio') * F('stock'),
            descuento=F('precio_base') - F('precio'),
            porcentaje_descuento=(F('precio_base') - F('precio')) * 100 / F('precio_base')
        )

        # Anotaciones con Count
        productos = cls.objects.annotate(
            num_reviews=Count('review'),
            num_ventas=Count('venta')
        )

        # Anotaciones con Case/When (if/else condicionales)
        from django.db.models import Case, When, Value, IntegerField

        productos = cls.objects.annotate(
            estado_stock=Case(
                When(stock=0, then=Value('Agotado')),
                When(stock__lt=10, then=Value('Bajo')),
                When(stock__lt=50, then=Value('Medio')),
                default=Value('Alto'),
                output_field=CharField()
            )
        )

        # Agrupación (GROUP BY)
        from django.db.models.functions import ExtractYear, ExtractMonth

        # Ventas por año y mes
        ventas_por_mes = cls.objects.annotate(
            año=ExtractYear('fecha_venta'),
            mes=ExtractMonth('fecha_venta')
        ).values('año', 'mes').annotate(
            total_ventas=Sum('cantidad'),
            ingresos=Sum(F('cantidad') * F('precio_unitario'))
        ).order_by('año', 'mes')

        # Concatenación de campos
        from django.db.models.functions import Concat
        from django.db.models import Value

        productos = cls.objects.annotate(
            nombre_completo=Concat(
                'nombre', Value(' - '), 'marca', Value(' ('), 'categoria__nombre', Value(')')
            )
        )

        return &quot;Ejemplos de consultas avanzadas de QuerySets&quot;
</code></pre>
<h2 id="14-consultas-y-joins-complejos">14. Consultas y joins complejos</h2>
<pre><code class="language-python">class Producto(models.Model):
    nombre = models.CharField(max_length=100)
    categoria = models.ForeignKey('Categoria', on_delete=models.CASCADE)

    @classmethod
    def consultas_complejas(cls):
        # select_related - Para relaciones ForeignKey y OneToOne
        productos = cls.objects.select_related('categoria', 'marca')

        # Ahora podemos acceder a producto.categoria.nombre sin consultas adicionales
        for producto in productos:
            print(f&quot;{producto.nombre} - {producto.categoria.nombre}&quot;)

        # prefetch_related - Para relaciones ManyToMany y &quot;relaciones inversas&quot;
        productos = cls.objects.prefetch_related('etiquetas', 'reviews')

        # Prefetch con Prefetch - Para personalizar la consulta prefetch
        from django.db.models import Prefetch

        productos = cls.objects.prefetch_related(
            Prefetch(
                'reviews',
                queryset=Review.objects.filter(rating__gte=4).select_related('usuario'),
                to_attr='buenas_reviews'
            )
        )

        # Consultas complejas con select_related + prefetch_related
        productos = cls.objects.select_related(
            'categoria', 'marca'
        ).prefetch_related(
            'etiquetas',
            Prefetch('reviews', queryset=Review.objects.select_related('usuario'))
        )

        # Consultas con joins explícitos
        from django.db.models import OuterRef, Subquery

        # Subconsulta - Última review de cada producto
        ultima_review = Review.objects.filter(
            producto=OuterRef('pk')
        ).order_by('-fecha_creacion').values('texto')[:1]

        productos = cls.objects.annotate(
            ultima_review=Subquery(ultima_review)
        )

        # Consultas en bruto (raw SQL)
        productos = cls.objects.raw(&quot;&quot;&quot;
            SELECT p.*, c.nombre as categoria_nombre
            FROM producto p
            JOIN categoria c ON p.categoria_id = c.id
            WHERE p.precio &gt; 100
            ORDER BY p.nombre
        &quot;&quot;&quot;)

        # Usando extra() para añadir JOIN, WHERE o SELECT
        productos = cls.objects.extra(
            select={'categoria_nombre': 'categoria.nombre'},
            tables=['categoria'],
            where=['producto.categoria_id = categoria.id', 'producto.precio &gt; 100']
        )

        return &quot;Ejemplos de consultas y joins complejos&quot;
</code></pre>
<h2 id="15-transacciones-y-operaciones-atomicas">15. Transacciones y operaciones atómicas</h2>
<pre><code class="language-python">from django.db import transaction

class Venta(models.Model):
    producto = models.ForeignKey('Producto', on_delete=models.CASCADE)
    cantidad = models.PositiveIntegerField()

    @classmethod
    def realizar_venta(cls, producto_id, cantidad, cliente_id):
        # Transacción atómica decorando función
        @transaction.atomic
        def _realizar_venta():
            # Todo esto ocurre dentro de una transacción
            producto = Producto.objects.select_for_update().get(id=producto_id)

            if producto.stock &lt; cantidad:
                raise ValueError(&quot;Stock insuficiente&quot;)

            # Actualizar stock
            producto.stock -= cantidad
            producto.save(update_fields=['stock'])

            # Crear venta
            venta = cls.objects.create(
                producto=producto,
                cantidad=cantidad,
                cliente_id=cliente_id
            )

            # Actualizar estadísticas
            ProductoEstadistica.objects.update_or_create(
                producto=producto,
                defaults={'total_vendido': F('total_vendido') + cantidad}
            )

            return venta

        return _realizar_venta()

    @classmethod
    def otro_ejemplo_transacciones(cls):
        # Usando with para bloques de transacción
        try:
            with transaction.atomic():
                # Todo dentro de este bloque es parte de la misma transacción
                producto1 = Producto.objects.select_for_update().get(id=1)
                producto1.stock -= 1
                producto1.save()

                producto2 = Producto.objects.select_for_update().get(id=2)
                producto2.stock -= 1

                if producto2.stock &lt; 0:
                    # Si hay un error, toda la transacción se deshace
                    raise ValueError(&quot;Stock insuficiente para producto 2&quot;)

                producto2.save()
        except Exception as e:
            # La transacción se ha deshecho, ningún cambio se guardó
            return f&quot;Error en la transacción: {str(e)}&quot;

        # Puntos de guardado (savepoints)
        with transaction.atomic():
            # Punto de guardado 1
            sid1 = transaction.savepoint()

            producto1 = Producto.objects.get(id=1)
            producto1.stock -= 1
            producto1.save()

            if alguna_condicion:
                # Deshacer hasta el punto de guardado 1
                transaction.savepoint_rollback(sid1)
            else:
                # Confirmar el punto de guardado 1
                transaction.savepoint_commit(sid1)

                # Punto de guardado 2
                sid2 = transaction.savepoint()

                try:
                    producto2 = Producto.objects.get(id=2)
                    producto2.stock -= 1
                    producto2.save()
                except:
                    # Deshacer hasta el punto de guardado 2
                    transaction.savepoint_rollback(sid2)

        return &quot;Ejemplos de transacciones&quot;
</code></pre>
<h2 id="16-indices-constraints-y-referencias-complejas">16. Índices, Constraints y Referencias complejas</h2>
<pre><code class="language-python">class Categoria(models.Model):
    nombre = models.CharField(max_length=100)

    class Meta:
        verbose_name_plural = &quot;Categorías&quot;

class Producto(models.Model):
    nombre = models.CharField(max_length=100)
    sku = models.CharField(max_length=20)
    precio = models.DecimalField(max_digits=10, decimal_places=2)
    categoria = models.ForeignKey(
        Categoria, 
        on_delete=models.PROTECT,  # No permite eliminar categorías con productos
        related_name='productos'
    )
    proveedor = models.ForeignKey(
        'Proveedor',
        on_delete=models.SET_NULL,  # Permite eliminar proveedores, poniendo NULL
        null=True,
        blank=True
    )
    productos_relacionados = models.ManyToManyField(
        'self',              # Relación a sí mismo
        symmetrical=False,   # A-&gt;B no implica B-&gt;A
        blank=True
    )
    # Índices simples y compuestos (Django 2.2+)
    class Meta:
        indexes = [
            models.Index(fields=['nombre']),
            models.Index(fields=['categoria', 'precio']),
            models.Index(fields=['sku'], name='idx_producto_sku'),
            # Índice parcial solo para productos activos
            models.Index(
                fields=['nombre'],
                name='idx_producto_activo_nombre',
                condition=models.Q(activo=True)
            ),
            # Índice para búsqueda de texto
            models.Index(
                name='idx_producto_busqueda',
                fields=['nombre', 'descripcion'],
                opclasses=['varchar_pattern_ops', 'text_pattern_ops']
            ),
        ]

        # Constraints complejas (Django 2.2+)
        constraints = [
            # Restricción de unicidad 
            models.UniqueConstraint(
                fields=['sku', 'proveedor'],
                name='uq_producto_sku_proveedor'
            ),
            # Restricción de unicidad condicional
            models.UniqueConstraint(
                fields=['slug'],
                condition=models.Q(activo=True),
                name='uq_producto_activo_slug'
            ),
            # Restricción CHECK
            models.CheckConstraint(
                check=models.Q(precio__gt=0),
                name='chk_producto_precio_positivo'
            ),
            models.CheckConstraint(
                check=models.Q(fecha_fin__gt=models.F('fecha_inicio')),
                name='chk_producto_fechas_validas'
            ),
        ]
</code></pre>
<h2 id="17-funciones-de-busqueda-y-expresiones-avanzadas">17. Funciones de Búsqueda y Expresiones Avanzadas</h2>
<pre><code class="language-python">from django.db.models import F, Func, Value
from django.db.models.functions import Concat, Lower, Upper, Substr, Length, Replace, ExtractYear, Cast
from django.db.models import CharField, IntegerField, DateField

class Producto(models.Model):
    nombre = models.CharField(max_length=100)
    descripcion = models.TextField()
    precio = models.DecimalField(max_digits=10, decimal_places=2)
    fecha_creacion = models.DateTimeField(auto_now_add=True)

    @classmethod
    def funciones_avanzadas(cls):
        # Operaciones con texto
        productos = cls.objects.annotate(
            # Concatenación
            titulo_completo=Concat(
                'nombre', Value(' - '), 'categoria__nombre',
                output_field=CharField()
            ),
            # Minúsculas y mayúsculas
            nombre_lower=Lower('nombre'),
            nombre_upper=Upper('nombre'),
            # Subcadenas
            primera_letra=Substr('nombre', 1, 1),
            # Longitud
            longitud_nombre=Length('nombre'),
            # Reemplazo
            sin_espacios=Replace('nombre', Value(' '), Value('_'))
        )

        # Operaciones con fecha
        productos = cls.objects.annotate(
            # Extraer componentes de fecha
            año=ExtractYear('fecha_creacion'),
            mes=ExtractMonth('fecha_creacion'),
            # Diferencia entre fechas
            dias_activo=Cast(
                Now() - F('fecha_creacion'),
                output_field=DurationField()
            )
        )

        # Funciones matemáticas
        from django.db.models.functions import Abs, Ceil, Floor, Round, Sin, Cos, Sqrt, Power

        productos = cls.objects.annotate(
            precio_redondeado=Round('precio'),
            precio_techo=Ceil('precio'),
            precio_suelo=Floor('precio'),
            precio_absoluto=Abs('precio'),
            precio_raiz=Sqrt('precio'),
            precio_cuadrado=Power('precio', 2)
        )

        # Creando funciones personalizadas
        class GroupConcat(Func):
            function = 'GROUP_CONCAT'
            template = '%(function)s(%(expressions)s)'

        # Usando funciones SQL directamente
        from django.db.models.expressions import RawSQL

        productos = cls.objects.annotate(
            distancia=RawSQL(
                &quot;ST_Distance(ubicacion, ST_SetSRID(ST_MakePoint(%s, %s), 4326))&quot;,
                (longitude, latitude)
            )
        ).order_by('distancia')

        return &quot;Ejemplos de expresiones y funciones avanzadas&quot;
</code></pre>
<h2 id="18-opciones-de-definicion-de-modelos-menos-comunes">18. Opciones de Definición de Modelos menos comunes</h2>
<pre><code class="language-python">class ProductoPersonalizado(models.Model):
    # Campo proxy que apunta a otro modelo pero con un nombre diferente
    categoria = models.ForeignKey(
        'Categoria',
        on_delete=models.CASCADE,
        db_column='categoria_id',          # Nombre de columna en la BD
        to_field='codigo_categoria',       # Campo en Categoria (no es la PK)
        related_name='mis_productos',      # Nombre de la relación inversa
        related_query_name='mi_producto',  # Nombre para filtros inversos
        limit_choices_to={'activa': True}, # Limita las opciones disponibles
        swappable=True,                   # Si el modelo relacionado es intercambiable
    )

    # Definir un Manager de forma explícita con una función
    def productos_activos():
        return models.Manager().from_queryset(
            lambda self: self.filter(activo=True)
        )()

    activos = productos_activos()

    # Opciones menos comunes para campos
    codigo_promocional = models.CharField(
        max_length=10,
        db_collation='utf8_bin',            # Collation específica (sensible a mayúsculas/minúsculas)
        db_index=True,                      # Índice en la BD para este campo
    )

    # Campo con restricciones de BD pero sin restricciones en Python
    codigo_interno = models.CharField(
        max_length=50,
        db_column='internal_code',          # Nombre en la BD
        error_messages={                    # Mensajes de error personalizados
            'blank': 'Este campo no puede estar vacío.',
            'unique': 'Ya existe un producto con este código interno.'
        }
    )

    # Definir una PK personalizada
    codigo_unico = models.CharField(
        max_length=20,
        primary_key=True,                   # Este campo es la PK
        editable=False,                     # No se puede editar desde el admin
    )

    class Meta:
        # Definir permisos a nivel de modelo
        default_permissions = ('add', 'change', 'delete', 'view')
        permissions = [
            ('puede_publicar', 'Puede publicar productos'),
            ('puede_comprar', 'Puede comprar productos'),
        ]

        # Definir índice funcional
        indexes = [
            models.Index(
                Lower('nombre'),
                name='idx_lower_nombre'
            )
        ]

        # Controlar si Django maneja las tablas
        managed = True                      # Django gestiona esta tabla

        # Definir vistas de base de datos
        managed = False                     # Para usar con vistas de BD
        db_table = 'productos_activos_view' # Vista definida en la BD
</code></pre>
<h2 id="19-integracion-con-otros-sistemas-y-orm-avanzado">19. Integración con otros sistemas y ORM avanzado</h2>
<pre><code class="language-python"># Integración con PostgreSQL - Campos específicos
from django.contrib.postgres.fields import ArrayField, HStoreField, JSONField
from django.contrib.postgres.search import SearchVectorField, SearchVector, SearchQuery, SearchRank
from django.contrib.postgres.indexes import GinIndex

class ProductoPostgreSQL(models.Model):
    nombre = models.CharField(max_length=100)
    tags = ArrayField(
        models.CharField(max_length=50),
        size=10,                         # Limita a 10 elementos
        blank=True,                      # Permite array vacío
        default=list                     # Valor por defecto
    )
    atributos = HStoreField(default=dict)  # Diccionario clave-valor
    metadatos = JSONField(default=dict)   # Campo JSON

    # Para búsqueda de texto completo
    search_vector = SearchVectorField(null=True)

    class Meta:
        indexes = [
            GinIndex(fields=['search_vector'])  # Índice GIN para búsqueda rápida
        ]

    def save(self, *args, **kwargs):
        # Actualiza el vector de búsqueda al guardar
        self.search_vector = (
            SearchVector('nombre', weight='A') + 
            SearchVector('descripcion', weight='B')
        )
        super().save(*args, **kwargs)

    @classmethod
    def buscar(cls, consulta):
        search_query = SearchQuery(consulta)
        return cls.objects.annotate(
            rank=SearchRank(F('search_vector'), search_query)
        ).filter(
            search_vector=search_query
        ).order_by('-rank')

    @classmethod
    def consultas_especiales_postgres(cls):
        # Consulta en array (contiene elementos)
        productos = cls.objects.filter(tags__contains=['oferta', 'nuevo'])

        # Consulta en json/hstore
        productos = cls.objects.filter(metadatos__contains={'color': 'rojo'})
        productos = cls.objects.filter(metadatos__color='rojo')

        # Conteo de elementos array
        from django.contrib.postgres.aggregates import ArrayLength
        productos = cls.objects.annotate(
            num_tags=ArrayLength('tags', 1)  # 1 indica dimensión del array
        ).filter(num_tags__gt=3)

        return &quot;Consultas especiales PostgreSQL&quot;

# Modelos no mapeados directamente a tablas
class VentasReporte(models.Model):
    &quot;&quot;&quot;Modelo para manejar reportes complejos sin tabla directa&quot;&quot;&quot;
    class Meta:
        managed = False  # No crea tabla

    @classmethod
    def ventas_por_mes(cls, año):
        &quot;&quot;&quot;Obtiene datos que no corresponden a un solo modelo&quot;&quot;&quot;
        return Venta.objects.filter(
            fecha__year=año
        ).annotate(
            mes=ExtractMonth('fecha')
        ).values('mes').annotate(
            total=Sum('total')
        ).order_by('mes')
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
